{% extends "base.html" %}

{% block title %}Financial Analysis{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h1 class="m-0">Financial Analysis</h1>
        <button onclick="window.print()" class="btn btn-outline-secondary">Download Report (PDF)</button>
    </div>

    <!-- Report Header (shown only on print) -->
    <div class="report-header print-only">
        <h2 class="text-center">Kokan Kinara - Financial Analysis Report</h2>
        <div class="d-flex justify-content-between" style="margin-top:8px;">
            <div><strong>Generated:</strong> <span id="generatedAt"></span></div>
            <div><strong>Prepared By:</strong> System</div>
        </div>
        <hr>
    </div>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Income</h5>
                    <h3>₹{{ "%.2f"|format(total_income) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Expenses</h5>
                    <h3>₹{{ "%.2f"|format(total_expense) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Booking Stay</h5>
                    <h3>₹{{ "%.2f"|format(total_booking_stay) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Booking Food</h5>
                    <h3>₹{{ "%.2f"|format(total_booking_food) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Net Profit Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card {% if (total_income - total_expense) >= 0 %}bg-success{% else %}bg-danger{% endif %} text-white">
                <div class="card-body">
                    <h5 class="card-title">Net Profit/Loss</h5>
                    <h2>₹{{ "%.2f"|format(total_income - total_expense) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <h5 class="card-title">Other Expenses</h5>
                    <h3>₹{{ "%.2f"|format(total_other_expenses) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Breakdown -->
    <div class="card">
        <div class="card-header">
            <h4>Monthly Breakdown</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Month</th>
                            <th>Bookings</th>
                            <th>Stay Amount</th>
                            <th>Food Amount</th>
                            <th>Total Booking</th>
                            <th>Other Income</th>
                            <th>Other Expenses</th>
                            <th>Net Income</th>
                            <th>Net Profit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for month_key, data in monthly_data %}
                        <tr>
                            <td><strong>{{ data.month_name }}</strong></td>
                            <td>{{ data.booking_count }}</td>
                            <td>₹{{ "%.2f"|format(data.booking_stay_amount) }}</td>
                            <td>₹{{ "%.2f"|format(data.booking_food_amount) }}</td>
                            <td>₹{{ "%.2f"|format(data.total_booking_amount) }}</td>
                            <td>₹{{ "%.2f"|format(data.total_income - data.total_booking_amount) }}</td>
                            <td>₹{{ "%.2f"|format(data.other_expenses) }}</td>
                            <td>₹{{ "%.2f"|format(data.total_income) }}</td>
                            <td class="{% if (data.total_income - data.total_expense) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ₹{{ "%.2f"|format(data.total_income - data.total_expense) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts Section (hidden on print) -->
    <div class="row mt-4 no-print">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Income vs Expenses by Month</h5>
                </div>
                <div class="card-body">
                    <canvas id="incomeExpenseChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Booking Breakdown by Month</h5>
                </div>
                <div class="card-body">
                    <canvas id="bookingBreakdownChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Income vs Expenses Chart
    const monthlyData = {{ monthly_data | tojson }};
    const months = monthlyData.map(item => item[1].month_name);
    const incomeData = monthlyData.map(item => item[1].total_income);
    const expenseData = monthlyData.map(item => item[1].total_expense);
    
    const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
    new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Income',
                data: incomeData,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }, {
                label: 'Expenses',
                data: expenseData,
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Booking Breakdown Chart
    const stayData = monthlyData.map(item => item[1].booking_stay_amount);
    const foodData = monthlyData.map(item => item[1].booking_food_amount);
    
    const ctx2 = document.getElementById('bookingBreakdownChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Stay Amount',
                data: stayData,
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            }, {
                label: 'Food Amount',
                data: foodData,
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
<style>
@media print {
  /* Hide navigation, buttons, and charts */
  .no-print, nav, .btn, canvas, .card-header h5 { display: none !important; }
  .print-only { display: block !important; }

  /* Use full width and remove shadows/bg colors for print */
  .container { width: 100% !important; max-width: 100% !important; }
  .card { box-shadow: none !important; border: 1px solid #000 !important; }
  .card.bg-success, .card.bg-danger, .card.bg-info, .card.bg-warning, .card.bg-secondary { background: #fff !important; color: #000 !important; }
  .table { width: 100% !important; }
  .table thead.table-dark th { background: #000 !important; color: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .text-success, .text-danger { color: #000 !important; }

  /* Page break after the table if content continues */
  .page-break { page-break-after: always; }

  /* Add margins suitable for PDF */
  @page { margin: 16mm 14mm; }
}

/* On screen only */
.print-only { display: none; }
</style>

<script>
  // Set generated timestamp for the report header (works for both view and print)
  (function setGeneratedAt(){
    var el = document.getElementById('generatedAt');
    if (el) {
      var now = new Date();
      var options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' };
      el.textContent = now.toLocaleString(undefined, options);
    }
  })();
</script>
{% endblock %}
